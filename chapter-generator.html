// ... existing code ...

// Generate config.js content
function generateConfigJS() {
    const chapterInfo = {
        title: document.getElementById('chapter-title').value || 'Chapter Title',
        subject: document.getElementById('subject').value || 'Subject',
        class: document.getElementById('class-level').value || 'Class Level',
        chapter: parseInt(document.getElementById('chapter-number').value) || 1,
        description: document.getElementById('chapter-description').value || 'Chapter description'
    };
    
    // Get highlights
    const highlights = [];
    document.querySelectorAll('#highlights-container .highlight-item').forEach(item => {
        highlights.push({
            icon: item.querySelector('.highlight-icon').value || 'fas fa-star',
            text: item.querySelector('.highlight-text').value || 'Highlight point'
        });
    });
    
    // Get about content
    const aboutContent = document.getElementById('about-content').value || '<p>About this chapter</p>';
    
    // Get topics
    const topics = [];
    document.querySelectorAll('#topics-container .topic-item').forEach((item, index) => {
        const topicId = item.querySelector('.topic-id').value || `topic${index + 1}`;
        const topicTitle = item.querySelector('.topic-title').value || `Topic ${index + 1}`;
        const navTitle = item.querySelector('.topic-navtitle').value || topicTitle;
        const icon = item.querySelector('.topic-icon').value || 'fas fa-book';
        const image = item.querySelector('.topic-image').value || '';
        const content = item.querySelector('.topic-content').value || '<p>Topic content</p>';
        
        // Get question options
        const questionText = item.querySelector('.topic-question-text').value;
        const options = [];
        item.querySelectorAll('.topic-option').forEach(option => {
            if (option.value.trim()) {
                options.push(option.value);
            }
        });
        
        // Only include question if text and options are provided
        let question = null;
        if (questionText && options.length > 0) {
            question = {
                text: questionText,
                options: options,
                correctAnswer: 0 // First option is always correct
            };
        }
        
        topics.push({
            id: topicId,
            title: topicTitle,
            icon: icon,
            navTitle: navTitle,
            image: image,
            content: content,
            question: question
        });
    });
    
    // Get vocabulary
    const vocabulary = [];
    document.querySelectorAll('#vocabulary-container .vocab-item').forEach(item => {
        const word = item.querySelector('.vocab-word').value;
        const definition = item.querySelector('.vocab-definition').value;
        
        if (word && definition) {
            vocabulary.push({
                word: word,
                definition: definition
            });
        }
    });
    
    // Generate the config code
    return `/**
 * Chapter Configuration
 * This file contains all the content for the chapter.
 * Edit this file to change content without touching the code structure.
 */

// Check if chapterConfig already exists to avoid redeclaration
if (!window.chapterConfig) {
    window.chapterConfig = {
        // Basic chapter information
        chapterInfo: {
            title: "${escapeString(chapterInfo.title)}",
            subject: "${escapeString(chapterInfo.subject)}",
            class: "${escapeString(chapterInfo.class)}",
            chapter: ${chapterInfo.chapter},
            description: "${escapeString(chapterInfo.description)}"
        },
        
        // Introduction section
        introduction: {
            highlights: [
                ${highlights.map(h => `{
                    icon: "${escapeString(h.icon)}",
                    text: "${escapeString(h.text)}"
                }`).join(',\n                ')}
            ],
            about: {
                content: \`
                    ${aboutContent}
                \`
            }
        },
        
        // Topic sections
        topics: [
            ${topics.map(t => `{
                id: "${escapeString(t.id)}",
                title: "${escapeString(t.title)}",
                icon: "${escapeString(t.icon)}",
                navTitle: "${escapeString(t.navTitle)}",
                image: "${escapeString(t.image)}",
                content: \`
                    ${t.content}
                \`,
                ${t.question ? `question: {
                    text: "${escapeString(t.question.text)}",
                    options: [
                        ${t.question.options.map(o => `"${escapeString(o)}"`).join(',\n                        ')}
                    ],
                    correctAnswer: ${t.question.correctAnswer}
                }` : '// No question for this topic'}
            }`).join(',\n            ')}
        ],
        
        // New words and terms
        vocabulary: [
            ${vocabulary.map(v => `{
                word: "${escapeString(v.word)}",
                definition: "${escapeString(v.definition)}"
            }`).join(',\n            ')}
        ]
    };
}`;
}

// Generate questions.js content
function generateQuestionsJS() {
    // Collect all questions by type
    const questions = {
        mcq: [],
        fillBlanks: [],
        truefalse: [],
        shortAnswer: [],
        longAnswer: [],
        oneWordAnswers: [],
        spellingTests: [],
        sequenceQuestions: [],
        flipCards: []
    };
    
    // For each question type, get the added questions
    Object.keys(questions).forEach(type => {
        document.querySelectorAll(`.${type}-question`).forEach((item, index) => {
            // Get common fields
            const id = item.querySelector('.question-id')?.value || `${type}${index + 1}`;
            
            // Different handling based on question type
            let questionObj = { id };
            
            switch (type) {
                case 'mcq':
                    // Get question text
                    questionObj.question = item.querySelector('.question-text')?.value || '';
                    
                    // Get options and correct answer
                    const options = [];
                    let correctAnswer = 0;
                    item.querySelectorAll('.option-item').forEach((option, i) => {
                        const optionText = option.querySelector('.option-text')?.value || '';
                        if (optionText) {
                            options.push(optionText);
                            // Check if this option is marked as correct
                            if (option.querySelector('input[type="radio"]:checked')) {
                                correctAnswer = i;
                            }
                        }
                    });
                    
                    questionObj.options = options;
                    questionObj.correctAnswer = correctAnswer;
                    questionObj.explanation = item.querySelector('.explanation-text')?.value || '';
                    break;
                    
                case 'fillBlanks':
                    questionObj.question = item.querySelector('.question-text')?.value || '';
                    questionObj.correctAnswer = item.querySelector('.correct-answer')?.value || '';
                    questionObj.explanation = item.querySelector('.explanation-text')?.value || '';
                    break;
                    
                case 'truefalse':
                    questionObj.question = item.querySelector('.question-text')?.value || '';
                    
                    // Get whether true or false is the correct answer
                    const correctAnswerInput = item.querySelector('input[name^="tf-"]:checked');
                    questionObj.correctAnswer = correctAnswerInput ? correctAnswerInput.value === 'true' : false;
                    
                    questionObj.explanation = item.querySelector('.explanation-text')?.value || '';
                    break;
                    
                case 'shortAnswer':
                case 'longAnswer':
                    questionObj.question = item.querySelector('.question-text')?.value || '';
                    questionObj.modelAnswer = item.querySelector('.model-answer')?.value || '';
                    questionObj.explanation = item.querySelector('.explanation-text')?.value || '';
                    break;
                    
                case 'oneWordAnswers':
                    questionObj.question = item.querySelector('.question-text')?.value || '';
                    questionObj.correctAnswer = item.querySelector('.correct-answer')?.value || '';
                    questionObj.explanation = item.querySelector('.explanation-text')?.value || '';
                    break;
                    
                case 'spellingTests':
                    questionObj.word = item.querySelector('.complete-word')?.value || '';
                    questionObj.blankedWord = item.querySelector('.blanked-word')?.value || '';
                    questionObj.hint = item.querySelector('.hint-text')?.value || '';
                    questionObj.explanation = item.querySelector('.explanation-text')?.value || '';
                    break;
                    
                case 'sequenceQuestions':
                    // To be implemented
                    break;
                    
                case 'flipCards':
                    questionObj.front = item.querySelector('.front-text')?.value || '';
                    questionObj.back = item.querySelector('.back-text')?.value || '';
                    questionObj.explanation = item.querySelector('.explanation-text')?.value || '';
                    break;
            }
            
            // Add question to the appropriate category
            if (isValidQuestion(questionObj, type)) {
                questions[type].push(questionObj);
            }
        });
    });
    
    // Generate the questions code
    return `// Comprehensive Question Bank 

// Check if questionBank already exists before declaring
if (!window.questionBank) {
    window.questionBank = {
        // Multiple Choice Questions (MCQs)
        mcq: [
            ${questions.mcq.map(q => `{
                id: "${escapeString(q.id)}",
                question: "${escapeString(q.question)}",
                options: [
                    ${q.options.map(o => `"${escapeString(o)}"`).join(',\n                    ')}
                ],
                correctAnswer: ${q.correctAnswer},
                explanation: "${escapeString(q.explanation)}"
            }`).join(',\n            ')}
        ],

        // Fill in the Blanks
        fillBlanks: [
            ${questions.fillBlanks.map(q => `{
                id: "${escapeString(q.id)}",
                question: "${escapeString(q.question)}",
                correctAnswer: "${escapeString(q.correctAnswer)}",
                explanation: "${escapeString(q.explanation)}"
            }`).join(',\n            ')}
        ],

        // True or False
        truefalse: [
            ${questions.truefalse.map(q => `{
                id: "${escapeString(q.id)}",
                question: "${escapeString(q.question)}",
                correctAnswer: ${q.correctAnswer},
                explanation: "${escapeString(q.explanation)}"
            }`).join(',\n            ')}
        ],

        // Short Answer Questions
        shortAnswer: [
            ${questions.shortAnswer.map(q => `{
                id: "${escapeString(q.id)}",
                question: "${escapeString(q.question)}",
                modelAnswer: "${escapeString(q.modelAnswer)}",
                explanation: "${escapeString(q.explanation)}"
            }`).join(',\n            ')}
        ],

        // Long Answer Questions
        longAnswer: [
            ${questions.longAnswer.map(q => `{
                id: "${escapeString(q.id)}",
                question: "${escapeString(q.question)}",
                modelAnswer: "${escapeString(q.modelAnswer)}",
                explanation: "${escapeString(q.explanation)}"
            }`).join(',\n            ')}
        ],

        // One-Word Answer Questions
        oneWordAnswers: [
            ${questions.oneWordAnswers.map(q => `{
                id: "${escapeString(q.id)}",
                question: "${escapeString(q.question)}",
                correctAnswer: "${escapeString(q.correctAnswer)}",
                explanation: "${escapeString(q.explanation)}"
            }`).join(',\n            ')}
        ],

        // Spelling Tests
        spellingTests: [
            ${questions.spellingTests.map(q => `{
                id: "${escapeString(q.id)}",
                word: "${escapeString(q.word)}",
                blankedWord: "${escapeString(q.blankedWord)}",
                hint: "${escapeString(q.hint)}",
                explanation: "${escapeString(q.explanation)}"
            }`).join(',\n            ')}
        ],

        // Flip Cards
        flipCards: [
            ${questions.flipCards.map(q => `{
                id: "${escapeString(q.id)}",
                front: "${escapeString(q.front)}",
                back: "${escapeString(q.back)}",
                explanation: "${escapeString(q.explanation)}"
            }`).join(',\n            ')}
        ]
    };
}`;
}

// Helper function to check if a question has the required fields
function isValidQuestion(question, type) {
    switch (type) {
        case 'mcq':
            return question.question && question.options && question.options.length > 1;
        case 'fillBlanks':
        case 'oneWordAnswers':
            return question.question && question.correctAnswer;
        case 'truefalse':
            return question.question;
        case 'shortAnswer':
        case 'longAnswer':
            return question.question && question.modelAnswer;
        case 'spellingTests':
            return question.word && question.blankedWord;
        case 'flipCards':
            return question.front && question.back;
        default:
            return false;
    }
}

// Helper function to escape special characters in strings
function escapeString(str) {
    if (typeof str !== 'string') return '';
    return str
        .replace(/\\/g, '\\\\')
        .replace(/"/g, '\\"')
        .replace(/\n/g, '\\n')
        .replace(/\r/g, '\\r')
        .replace(/\t/g, '\\t');
}
</script>
</body>
</html>
